name: Quality Check & Build Validation

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-check:
    name: Code Quality & Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç TypeScript type checking
        id: typecheck
        run: npm run check
        continue-on-error: true

      - name: üèóÔ∏è Build project
        id: build
        run: npm run build
        continue-on-error: false

      - name: üìä Check build output
        run: |
          if [ -d "dist" ]; then
            echo "‚úÖ Build output directory exists"
            echo "üìÅ Build size: $(du -sh dist | cut -f1)"
            echo "üìÑ Files generated: $(find dist -type f | wc -l)"
          else
            echo "‚ùå Build output directory not found"
            exit 1
          fi

      - name: üîé Structure validation
        run: |
          echo "üîç Checking project structure..."
          
          # Check required directories
          REQUIRED_DIRS=("src/pages" "src/components" "src/layouts" "public")
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "‚úÖ $dir exists"
            else
              echo "‚ö†Ô∏è  Warning: $dir is missing"
            fi
          done
          
          # Check for common files
          COMMON_FILES=("astro.config.mjs" "tsconfig.json" "package.json")
          for file in "${COMMON_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file found"
            else
              echo "‚ö†Ô∏è  Warning: $file is missing"
            fi
          done

      - name: üìù TypeCheck results comment
        if: steps.typecheck.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è  TypeScript type checking found some issues"
          echo "These are non-blocking warnings - build succeeded"
          echo "Consider reviewing type definitions for better code quality"

      - name: ‚úÖ Quality check summary
        run: |
          echo "==================== SUMMARY ===================="
          echo "TypeScript Check: ${{ steps.typecheck.outcome }}"
          echo "Build Status: ${{ steps.build.outcome }}"
          echo "================================================"
          
          if [ "${{ steps.build.outcome }}" = "success" ]; then
            echo "‚úÖ All critical checks passed!"
            echo "üöÄ Ready for deployment"
          else
            echo "‚ùå Build failed - please fix errors"
            exit 1
          fi

      - name: üíæ Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist
          retention-days: 7

  # Job optionnel : v√©rification des performances
  performance-check:
    name: Performance & Best Practices
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'pull_request'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üèóÔ∏è Build for analysis
        run: npm run build

      - name: üìä Bundle size analysis
        run: |
          echo "üì¶ Analyzing bundle sizes..."
          
          # CSS files
          echo ""
          echo "üìÑ CSS Files:"
          find dist -name "*.css" -exec du -h {} \; | sort -h
          
          # JS files
          echo ""
          echo "üìÑ JavaScript Files:"
          find dist -name "*.js" -exec du -h {} \; | sort -h
          
          # Images
          echo ""
          echo "üñºÔ∏è  Image Files:"
          find dist -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" | head -20 | xargs du -h 2>/dev/null || echo "No images found"
          
          # Total size
          echo ""
          echo "üìä Total Build Size:"
          du -sh dist

      - name: üîç SEO & Accessibility hints
        run: |
          echo "üîç Basic SEO checks..."
          
          # Check for meta tags in HTML files
          HTML_FILES=$(find dist -name "*.html")
          
          for file in $HTML_FILES; do
            echo ""
            echo "Checking: $file"
            
            if grep -q "<title>" "$file"; then
              echo "  ‚úÖ Title tag found"
            else
              echo "  ‚ö†Ô∏è  Warning: No title tag"
            fi
            
            if grep -q 'meta name="description"' "$file"; then
              echo "  ‚úÖ Meta description found"
            else
              echo "  ‚ö†Ô∏è  Warning: No meta description"
            fi
            
            if grep -q 'lang=' "$file"; then
              echo "  ‚úÖ Language attribute found"
            else
              echo "  ‚ö†Ô∏è  Warning: No language attribute"
            fi
          done

      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request'
        run: |
          echo "üìù Performance analysis completed"
          echo "Review the job logs for detailed metrics"
